(function(h,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(h=typeof globalThis<"u"?globalThis:h||self,g(h.mindwired={}))})(this,function(h){"use strict";var Vs=Object.defineProperty;var Xs=(h,g,b)=>g in h?Vs(h,g,{enumerable:!0,configurable:!0,writable:!0,value:b}):h[g]=b;var c=(h,g,b)=>Xs(h,typeof g!="symbol"?g+"":g,b);const g={DRAG:{VIEWPORT:{name:"viewport.dragged",desc:""},NODE:{name:"node.dragged",desc:""}},NODE:{CREATED:{name:"node.created",desc:"new node created",CLIENT:{name:"node.created.client",desc:"client-side node creation event"}},DELETED:{name:"node.deleted_old",desc:"node has been deleted",CLIENT:{name:"node.deleted_old.client",desc:"client-side node deletion event"}},DELETED2:{name:"node.deleted",desc:"node has been deleted",CLIENT:{name:"node.deleted.client",desc:"client-side node deletion event"}},UPDATED:{name:"node.updated",desc:"content of node updated",CLIENT:{name:"node.updated.client",desc:"client-side node update event"}},SELECTED:{name:"node.selected",desc:"one or more nodes selected",CLIENT:{name:"node.selected.client",desc:"client-side node selection event"}},CLICKED:{name:"node.clicked",desc:"a node clicked(without dragging)",CLIENT:{name:"node.clicked.client",desc:"client-side node click event"}},EDITING:{name:"node.editing",desc:"node's editing state",CLIENT:{name:"node.editing.client",desc:"client-side node editing state"}},FOLDED:{name:"node.folded",desc:"node is folded or unfolded",CLIENT:{name:"node.folded.client",desc:"client-side node editing state"}},MOVED:{name:"node.moved",desc:"node is folded or unfolded",CLIENT:{name:"node.moved.client",desc:"client-side node editing state"}}},VIEWPORT:{RESIZED:{name:"viewport.resized",desc:"viewport size chaged"},CLICKED:{name:"viewport.clicked",desc:"viewport has been clicked"}},SCHEMA:{CREATED:{name:"schema.created",desc:"",CLIENT:{name:"schema.created.client",desc:""}},UPDATED:{name:"schema.updated",desc:"",CLIENT:{name:"schema.updated.client",desc:""}},DELETED:{name:"schema.deleted",desc:"",CLIENT:{name:"schema.deleted.client",desc:""}}}},b=g,Ct=n=>{const e=n.toUpperCase().split(".");let t=g;for(let s=0;s<e.length;s++)if(t=t[e[s]],!t)throw new Error(`invalid event name: [${n}]`);if(t.name!==n)throw new Error(`event name mismatch: [${n}]`);return t};class Dt{constructor(){c(this,"callbacks");this.callbacks=new Map}on(e,t){let s=this.callbacks.get(e.name);s||(s=[],this.callbacks.set(e.name,s)),s.push(t)}off(e,t){const s=this.callbacks.get(e);if(!s)return;const i=s.findIndex(o=>o===t);s.splice(i,1)}listen(e,t){this.on(e,t)}emit(e,t){(this.callbacks.get(e.name)||[]).forEach(i=>{try{i(t)}catch(o){console.log(o)}})}}const Nt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20height='24'%20viewBox='0%20-960%20960%20960'%20width='24'%3e%3cpath%20d='M480-134.616%20313.078-301.539l43.383-43.383L480-221.384l123.539-123.538%2043.383%2043.383L480-134.616Zm-123.539-478L313.078-656%20480-822.922%20646.922-656l-43.383%2043.384L480-736.155%20356.461-612.616Z'/%3e%3c/svg%3e",St="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20height='24px'%20viewBox='0%200%2024%2024'%20width='24px'%20fill='%23000000'%3e%3cpath%20d='M0%200h24v24H0V0z'%20fill='none'/%3e%3cpath%20d='M12%202C6.48%202%202%206.48%202%2012s4.48%2010%2010%2010%2010-4.48%2010-10S17.52%202%2012%202zm0%2018c-4.41%200-8-3.59-8-8s3.59-8%208-8%208%203.59%208%208-3.59%208-8%208zm3-13.5V9h-4v2h4v2.5l3.5-3.5zm-6%204L5.5%2014%209%2017.5V15h4v-2H9z'/%3e%3c/svg%3e",z=()=>{},Lt=z,Rt=z,W=n=>{let e=n.touches[0];n.type==="touchend"&&(e=n.changedTouches[0]),n.clientX=e.clientX,n.clientY=e.clientY,n.layerX=0,n.layerY=0,n.offsetX=0,n.offsetY=0,n.pageX=e.pageX,n.pageY=e.pageY,n.screenX=e.screenX,n.screenY=e.screenY},oe=n=>{clearTimeout(n.touchTimer),n.touchTimer=void 0},re=(n,e)=>{const{handler:t}=n;t.accept(e.target)&&(n.dragging={originalEvent:e,sx:e.pageX,sy:e.pageY,dx:0,dy:0,ghost:void 0,once:void 0},t.beforeDrag(n.dragging))},de=(n,e)=>{n.dragging&&(e.preventDefault(),n.dragging.once&&(n.dragging.once(),n.dragging.once=void 0),n.originalEvent=e,n.dragging.dx=e.pageX-n.dragging.sx,n.dragging.dy=e.pageY-n.dragging.sy,n.handler.dragging(n.dragging))},ae=(n,e)=>{n.originalEvent=e;const t=document.querySelector("body");t&&(t.style.cursor="");try{n.dragging&&n.handler.afterDrag(n.dragging)}catch(s){console.log("[DND error]",s)}finally{n.data.clear(),n.dragging=void 0}},Tt=(n,e)=>{n.touchTimer=window.setTimeout(()=>{W(e),re(n,e)},10)},$t=(n,e)=>{oe(n),W(e),de(n,e)},Mt=(n,e)=>{oe(n),W(e),ae(n,e)},_t=n=>{const{handler:e}=n;e.beforeDrag=e.beforeDrag||z,e.dragging=e.dragging||Lt,e.afterDrag=e.afterDrag||Rt,window.addEventListener("mousedown",t=>re(n,t),!1),window.addEventListener("mousemove",t=>de(n,t),{passive:!1}),window.addEventListener("mouseup",t=>ae(n,t),!1),window.addEventListener("touchstart",t=>Tt(n,t),!1),window.addEventListener("touchmove",t=>$t(n,t),{passive:!1}),window.addEventListener("toucend",t=>Mt(n,t),!1)};class Ot{constructor(e){c(this,"touchTimer");c(this,"dragging");c(this,"handler");c(this,"data");c(this,"originalEvent");this.touchTimer=void 0,this.handler=e,this.data=new Map,_t(this)}capture(e,t){this.data.set(e,t)}getData(e){return this.data.get(e)}}const kt=180/Math.PI,S=class S{constructor(e=0,t=0){c(this,"x");c(this,"y");this.x=e,this.y=t}clone(){return new S(this.x,this.y)}sum(e){return new S(this.x+e.x,this.y+e.y)}};c(S,"ZERO",new S(0,0));let y=S;class ce{constructor(e,t=y.ZERO){c(this,"_degree");this.target=e,this.base=t;const s=this.target.x-t.x,i=this.target.y-t.y;this._degree=Math.atan2(i===0?0:-i,s)*kt}get ccwx(){const e=this._degree;return e<0?360+e:e}get cwy(){let e=90-this._degree;return e<0?360+e:e}get quadrant(){const e=this.ccwx;if(e<90)return 1;if(e<180)return 2;if(e<270)return 3;if(e<360)return 4;throw new Error(`unexpected ccwx: ${e}`)}}class le{constructor(){c(this,"rotate",(e,t,s,i={scale:1})=>{const o=(t.x-e.x)*i.scale,r=(t.y-e.y)*i.scale,d=s*Math.PI/180,a=Math.cos(d),l=Math.sin(d);return{x:o*a-r*l+e.x,y:o*l+r*a+e.y}})}heading(e,t){return new ce(e,t)}}const B=new le,At=n=>({beforeDrag:()=>{},dragging:e=>{const{dx:t,dy:s}=e,i=n.dndContext.getData("iconEl");n.dom.css(i,{transform:`translate(calc(-50% + ${t}px), ${s}px)`})},afterDrag:()=>{const{dom:e}=n,t=n.dndContext.getData("iconEl"),s=e.domRect(t),i=s.x+s.width/2,o=s.y+s.height/2;e.css(t,{transform:"translate(-50%, 0)"});const r=n.findNodeAt(i,o);if(r){const a=n.config.mindWired().getSelectedNodes();a.filter(l=>r.isDescendantOf(l)).length>0||n.config.mindWired().moveNodes(r,a,!0)}}}),Pt=n=>({beforeDrag:e=>{const{target:t}=e.originalEvent,i=n.dom.closest(t,".mwd-node").dataset.uid;n.dndContext.capture("nodeId",i);const r=n.config.mindWired().findNode(d=>d.uid===i);n.config.emit(g.NODE.SELECTED,{nodes:[r],append:e.originalEvent.shiftKey,type:"select"}),n.config.emit(g.DRAG.NODE,{nodeId:i,state:"ready",target:e.originalEvent.shiftKey?"children":"all",x:0,y:0})},dragging:e=>{const{dx:t,dy:s}=e,i=n.dndContext.getData("nodeId"),{scale:o}=n.config;n.config.emit(g.DRAG.NODE,{nodeId:i,state:"drag",target:e.originalEvent.shiftKey?"children":"all",x:t/o,y:s/o})},afterDrag:e=>{const{dx:t,dy:s}=e,i=n.dndContext.getData("nodeId"),{scale:o}=n.config;n.config.emit(g.DRAG.NODE,{nodeId:i,state:"done",target:e.originalEvent.shiftKey?"children":"all",x:t/o,y:s/o})}}),zt=n=>({beforeDrag:e=>{n.dndContext.capture("offset",n.config.getOffset())},dragging:e=>{const{dx:t,dy:s}=e;if(t===0&&s===0)return;n.dndContext.capture("dragged",!0);const i=n.dndContext.getData("offset");n.config.emit(g.DRAG.VIEWPORT,{state:"drag",offset:new y(i.x+t,i.y+s)})},afterDrag:e=>{const{dx:t,dy:s}=e;if(t!==0||s!==0){const o=n.dndContext.getData("offset");n.config.emit(g.DRAG.VIEWPORT,{state:"done",offset:new y(o.x+t,o.y+s)})}n.dndContext.getData("dragged")||n.config.emit(g.VIEWPORT.CLICKED)}}),F={viewport:`<div data-mind-wired-viewport>
    <canvas></canvas>
    <div class="mwd-selection-area"><div class="ctrl-icon" data-cmd="set-para" style="display:none;"><img src="${St}"></div></div>
    <div class="mwd-nodes"></div>
  </div>`,node:`<div class="mwd-node">
    <div class="mwd-body" tabIndex="0"></div>
    <div class="mwd-subs"></div>
    <div class="mwd-node-ctrl"></div>
  </div>`,foldingControl:`<div class="ctrl-icon" data-cmd="unfolding"><img src="${Nt}"></div>`},Wt=n=>{var d;const{el:e,ui:t,dom:s}=n.config,i=t.width||600,o=t.height||600;let r=s.findOne(e,"[data-mind-wired-viewport]");return r||(r=s.parseTemplate(F.viewport,{}),t.useDefaultIcon||(d=r.querySelector("img"))==null||d.remove(),t.mapId&&(r.dataset.mindWiredViewport=t.mapId),e.append(r)),s.findOne(r,":scope > canvas")||r.appendChild(s.tag.canvas()),s.findOne(r,":scope > .mwd-selection-area")||r.appendChild(s.tag.div(".mwd-selection-area")),s.findOne(r,":scope > .mwd-nodes")||r.appendChild(s.tag.div(".mwd-nodes")),s.attr(r,"tabIndex","0"),s.css(r,{width:i,height:o}),r},he=n=>{if(n){const{devicePixelRatio:e}=window,{config:t,$viewport:s,$canvas:i}=n,{offsetWidth:o,offsetHeight:r}=s;n.dom.css(i,{width:o,height:r}),n.dom.attr(i,"width",String(e*o),!0),n.dom.attr(i,"height",String(e*r),!0);const d=i.getContext("2d",{alpha:!1});n.$ctx=d,n.$ctx.scale(e,e),n.drawNodeSelection(),t.emit(g.VIEWPORT.RESIZED)}},ue=(n,e,t)=>{const s=t.ui.clazz.schema(n);t.dom.clazz.add(e,s)},I=(n,e)=>{if(e.$el)throw new Error(`[MINDWIRED] already installed. (${e.uid})`);const t=e.$el=n.dom.parseTemplate(F.node),s=n.config.mindWired(),i=s.getNodeRender(e.model),o=s.translateModel(e.model),r=n.getNodeBody(e);i.install(e.model,r),o.schema&&(ue(o.schema,t,n.config),ue(o.schema,r,n.config));const d=n.elemOf(".mwd-nodes");if(e.isRoot())d.append(t);else try{n.dom.findOne(e.parent.$el,".mwd-subs").append(t)}catch{}return t.dataset.uid=e.uid,e.$el},H=(n,e,t=!1)=>{if(!e.$el)throw new Error(`[MINDWIRED][ERROR] not registered node. (${e.uid})`);if(e.$el.remove(),delete e.$el,t){const{subs:s}=e;s&&s.forEach(i=>H(n,i))}},Bt=n=>{const{dom:e}=n;return new Ot({accept:t=>{const s=n.config.mindWired();if(e.closest(t,"[data-editor-element]"))return!1;if(e.is(t,'[data-cmd="set-para"]')){const i=e.closest(t,'[data-cmd="set-para"]');return n.dndContext.capture("iconEl",i),n.dndContext.capture("handler",At(n)),!0}else{if(e.closest(t,"[data-cmd]"))return!1;if(e.is(t,"canvas"))return n.dndContext.capture("handler",zt(n)),!0;if(e.is(t,".mwd-node")){const o=e.closest(t,".mwd-node").dataset.uid;return n.dndContext.capture("handler",Pt(n)),n.dndContext.capture("nodeId",o),n.dndContext.capture("editing",s.isEditing()),!0}else return!1}},beforeDrag:t=>{n.dndContext.getData("handler").beforeDrag(t)},dragging:t=>{n.dndContext.getData("editing")||n.dndContext.getData("handler").dragging(t)},afterDrag:t=>{n.dndContext.getData("editing")||n.dndContext.getData("handler").afterDrag(t)}})},Ft=(n,e,t,s)=>{var o;let i=n.querySelector(':scope > [data-cmd="unfolding"]');if(!i){const{dom:r}=t;i=r.parseTemplate(F.foldingControl,{}),r.css(i,{transform:`translate(${e.width/2+4}px, -50%)`,zIndex:0}),t.ui.useDefaultIcon||(o=i.querySelector("img"))==null||o.remove(),n.append(i),s(i)}},q=(n,e,t)=>{e&&Object.keys(e).forEach(s=>{const i=e[s];i&&(n[s]=i)}),t&&t(n)};class ge{constructor(e){c(this,"config");c(this,"$viewport");c(this,"dndContext");c(this,"resizeObserver");c(this,"selectionArea");c(this,"$ctx");this.config=e,this.$viewport=Wt(this),he(this),this.dndContext=Bt(this);let t;const s=()=>{clearTimeout(t),t=window.setTimeout(he,150,this)};this.resizeObserver=new ResizeObserver(s),this.resizeObserver.observe(this.$viewport)}get dom(){return this.config.dom}get $canvas(){return this.$viewport.querySelector("canvas")}get $holder(){return this.$viewport.querySelector(".mwd-nodes")}get scale(){return this.config.scale}getContext(){return this.$ctx}getHolderOffset(){const e=this.$holder;return{x:e.offsetLeft,y:e.offsetTop}}setScale(e){const{scale:t}=this;if(typeof e=="number")return e*t;if(Array.isArray(e)){const s=[...e];return s.forEach((i,o)=>{s[o]=this.setScale(i)}),s}else if(typeof e=="object"){const s={...e};for(let i in s)s[i]=this.setScale(e[i]);return s}return e}getScaledPos(e){return e.x*=this.scale,e.y*=this.scale,e}getScaledOffset(e){return this.getScaledPos(e.offset())}getDimension(){const e=this.$canvas;return{width:e.offsetWidth,height:e.offsetHeight}}getNodeDimension(e,t=!1){const s=e.dimension(t),{scale:i}=this.config;return s.center.x*=i,s.center.y*=i,s}getAbsoluteDimensions(e){const t=e.map(i=>this.getNodeDimension(i));return t.reduce((i,o)=>i.merge(o),t[0])}elemOf(e){return this.$viewport.querySelector(e)}shiftBy(e,t){const s=this.config.getOffset();s.x+=e,s.y+=t,this.config.setOffset(s),this.repaintNodeHolder()}renderWith(e){const t=this.getContext(),s=this.getHolderOffset();try{t.translate(s.x,s.y),t.save(),e(t)}finally{t.restore(),t.translate(-s.x,-s.y)}}findNodeAt(e,t){const s=this.$holder.querySelectorAll(".mwd-body");let i=null;const{dom:o}=this;for(let l=0;l<s.length;l++){const u=o.domRect(s[l]);if(u.left<=e&&u.right>=e&&u.top<=t&&u.bottom>=t){i=s[l];break}}if(!i)return null;const r=this.config.mindWired(),d=o.closest(i,".mwd-node");return r.findNode(l=>l.uid===d.dataset.uid)}drawPath(e,t,s){this.renderWith(i=>{q(i,t,s),i.beginPath();let o=e[0];i.moveTo(o.x,o.y),e.forEach(r=>{i.lineTo(r.x,r.y)}),i.stroke()})}drawCurve(e,t,s,i){this.renderWith(o=>{q(o,s.props,i);const r=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)),d=s.degree,l=r*s.ratio/r*this.scale,u=B.rotate(e,t,d,{scale:l}),f=B.rotate(t,e,d,{scale:l});o.beginPath(),o.moveTo(e.x,e.y),o.bezierCurveTo(u.x,u.y,f.x,f.y,t.x,t.y),o.stroke()})}drawBeizeCurve(e,t,s,i){const o=this.getContext();o.save(),q(o,s.props,i);const[r,d]=s.cpoints,a=this.getHolderOffset();o.beginPath(),o.moveTo(a.x+e.x,a.y+e.y),o.bezierCurveTo(a.x+r.x,a.y+r.y,a.x+d.x,a.y+d.y,a.x+t.x,a.y+t.y),o.stroke(),o.restore()}drawVLines(e,t){const s=this.$viewport.offsetHeight,i=this.getContext();i.save(),typeof t=="function"&&t(i),i.beginPath();const o=this.getHolderOffset();e.forEach(r=>{i.moveTo(o.x+r,0),i.lineTo(o.x+r,s)}),i.stroke(),i.closePath(),i.restore()}drawHLines(e,t){const s=this.$viewport.offsetWidth,i=this.getContext();i.save(),typeof t=="function"&&t(i),i.beginPath();const o=this.getHolderOffset();e.forEach(r=>{i.moveTo(0,o.y+r),i.lineTo(s,o.y+r)}),i.stroke(),i.closePath(),i.restore()}clear(){const e=this.getDimension(),t=this.getContext();t.fillStyle="white",t.fillRect(0,0,e.width,e.height)}repaintNodeHolder(){const e=this.config.getOffset(),{scale:t}=this.config;this.dom.css(this.$holder,{top:`calc(50% + ${e.y}px)`,left:`calc(50% + ${e.x}px)`,transform:`scale(${t})`}),this.drawNodeSelection()}moveNode(e){const{parent:t}=e;this.dom.findOne(t.$el,".mwd-subs").append(e.$el)}drawNodeSelection(){const e=this.selectionArea;if(!e)return;const{selection:t}=this.config.ui,{dom:s}=this,i=this.getHolderOffset(),o=s.findOne(this.$viewport,".mwd-selection-area");s.css(o,{left:i.x+e.left-t.padding,top:i.y+e.top-t.padding,width:e.width+2*t.padding,height:e.height+2*t.padding});const r=s.findOne(o,"div");s.css(r,{display:"",width:24,height:24})}updateSelection(e){!e||e.length===0||(this.clearNodeSelection(),this.selectionArea=this.getAbsoluteDimensions(e),this.drawNodeSelection())}clearNodeSelection(){if(this.selectionArea){const{dom:e}=this,t=e.findOne(this.$viewport,".mwd-selection-area");e.css(t,{top:-1,left:-1,width:0,height:0});const s=e.findOne(t,"div");e.css(s,{display:"none"}),this.selectionArea=void 0}}drawNode(e){e.$el||I(this,e);const{$el:t,zIndex:s}=e,i=t.querySelector(".mwd-body"),o=this.config.foldedNodeClassName(),{dom:r}=this;e.isFolded()?r.clazz.add(t,o):r.clazz.remove(t,o);const d=e.getPos();r.css(t,{top:d.y,left:d.x,zIndex:s});const a=e.isSelected()?"add":"remove",l=this.config.activeClassName("node");r.clazz[a](i,l);const u=this.config.nodeLevelClassName(e);r.clazz.add(i,u),i.dataset.level=`${e.level()}`;const{style:f}=e.view;f&&r.renderStyle(i,f);const m=this.config.mindWired(),p=m.getNodeRender(e.model),w=m.translateModel(e.model);p.render(w,i,{selected:e.selected,editing:e.editing})}showNodeEditor(e,t){const{uid:s}=e,o=this.config.mindWired().translateModel(e.model),r=this.$holder.querySelector(`[data-uid=${s}]`),d=t.showEditor(o,r,e.getStyle("style"));return this.dom.css(d,{transform:`scale(${1/this.scale})`}),d.dataset.editorElement="",new Promise(a=>{setTimeout(a)})}hideNodeEditor(e){const{uid:t}=e,{dom:s}=this,i=this.$holder.querySelector(`[data-uid=${t}]`),o=s.findOne(i,"[data-editor-element]");o&&o.remove(),s.findOne(i,".mwd-body").focus()}regsiterNode(e){I(this,e)}unregisterNode(e){H(this,e),this.clearNodeSelection()}unregisterNodeTree(e){H(this,e,!0)}updateFoldingNodes(e){const t=e.isFolded()?"none":"",{dom:s}=this,i=s.findOne(this.$holder,`[data-uid="${e.uid}"]`),o=s.findOne(i,":scope > .mwd-subs");if(s.css(o,{display:t}),e.isFolded()){const r=s.domRect(e.$bodyEl);Ft(i,r,this.config,d=>{s.event.click(d,a=>{a.stopPropagation(),this.config.mindWired().setFoldingState([e],!1)})})}else s.findOne(i,':scope > [data-cmd="unfolding"]').remove()}getNodeBody(e){let t=e.$el;return t||(t=I(this,e)),t.querySelector(".mwd-body")}drawSchema(e){const{name:t,style:s}=e;if(s){const{mapId:i,styleDef:o}=this.config.ui,r=o.schema.styleId.replace("@schema",t).replace("@mapId",i?`-${i}`:"");let d=document.querySelector(r);d||(d=this.dom.tag.style(r),document.head.appendChild(d));const a=Object.keys(s).reduce((u,f)=>{const m=f.replace(/[A-Z]/g,p=>`-${p.toLowerCase()}`);return u+`${m}: ${s[f]};`},""),l=o.schema.selector.replace("@schema",t).replace("@mapId",i?`="${i}"`:"");d.innerHTML=`${l} { ${a} }`}}removeSchema(e){const{mapId:t,styleDef:s}=this.config.ui,i=s.schema.styleId.replace("@schema",e).replace("@mapId",t?`-${t}`:"");let o=document.querySelector(i);o&&o.remove()}bindSchema(e,t){const{model:s}=e.spec,{name:i}=t,o=s.schema?s.schema.split(" ").map(d=>d.trim()):[];if(o.includes(i))return!1;o.push(i),s.schema=o.join(" ").trim();const r=this.getNodeBody(e);return e.$el.classList.add(i),r.classList.add(i),!0}unbindSchema(e,t){const{model:s}=e.spec;if(!s.schema)return!1;const{name:i}=t,o=s.schema.split(" ").map(d=>d.trim()).filter(d=>d.length>0&&d!==i);s.schema=o.join(" ").trim(),s.schema.length===0&&delete s.schema;const r=this.getNodeBody(e);return e.$el.classList.remove(i),r.classList.remove(i),!0}}class L{get defaultOption(){}getRenderingOption(e){const t=e.$style.option,{defaultOption:s}=this;if(s!==void 0)for(let i in s)t[i]===void 0&&s[i]!==void 0&&(t[i]=s[i]);return t}}const It=n=>n&&n.valign||"center",R=(n,e,t,s)=>{const i=n[t],o=n[e];return new y(i,o+s)};class fe extends L{get name(){return"line"}render(e,t,s){const{scale:i}=e,[o,r]=[t,s].map(E=>e.getNodeDimension(E)),d=this.getRenderingOption(t),a=It(d),l=[],u=[],f=t.$style,m=f.width*i,p=s.$style,w=p.width*i,U=Math.abs(m-w),ee=w/2;if(a==="center")l.push(o.center,r.center);else if(a==="bottom"){const E=o.cx<=r.cx,P=E?2:-2,qs=E?"right":"left",wt=E?["left","right"]:["right","left"],te=R(o,"bottom",qs,ee),se=te.clone();se.x+=P;const ne=R(r,"bottom",wt[0],ee),ie=ne.clone();if(ie.x-=P,l.push(te,se,ie,ne),l.push(R(r,"bottom",wt[1],ee)),U>0){const xt=te.clone();xt.y+=U;const bt=se.clone();bt.y+=U,u.push(xt,bt,ie,ne)}}if(e.drawPath(l,{lineWidth:w,strokeStyle:p.color,lineJoin:"round"},E=>{p.dash&&E.setLineDash(p.dash)}),u.length>0&&e.drawPath(u,{lineWidth:w,strokeStyle:p.color,lineJoin:"round"},E=>{p.dash&&E.setLineDash(p.dash)}),t.isRoot()&&a==="bottom"){const E=m/2;e.drawPath([R(o,"bottom","left",E),R(o,"bottom","right",E)],{lineWidth:m,strokeStyle:f.color,lineJoin:"round"},P=>{f.dash&&P.setLineDash(f.dash)})}}}class me extends L{get name(){return"curve"}get defaultOption(){return{deg:20,ratio:.4}}render(e,t,s){const{scale:i}=e,[o,r]=[t,s].map(l=>e.getScaledOffset(l)),d=s.$style,a=this.getRenderingOption(s);e.drawCurve(o,r,{degree:a.deg||20,ratio:a.ratio||.4,props:{lineWidth:d.width*i,strokeStyle:d.color}},d.getEdgeRenderer())}}const Ht=n=>n&&n.valign||"center",_=(n,e,t,s)=>{const i=n[t],o=n[e];return new y(i,o+s)},pe=(n,e,t,s)=>{const i=s/2;n.drawPath([{x:t.left,y:t.bottom+i},{x:t.right,y:t.bottom+i}],{lineWidth:s,strokeStyle:e.color},o=>{e.dash&&o.setLineDash(e.dash)})},qt=(n,e,t,s,i)=>{const{scale:o}=n,r=t.width*o,d=i.width*o,a=Math.min(r,d),l=s.x-e.x,u=Math.abs(r-d);e.y-=u/2;const f={lineWidth:a,strokeStyle:i.color},m=p=>{i.dash&&p.setLineDash(i.dash)};n.drawBeizeCurve(e,s,{cpoints:[{x:e.x+l/2,y:e.y},{x:s.x-l/2,y:s.y}],props:f},m),u>0&&(e.y+=u,u/2>=d&&(f.lineWidth=r),n.drawBeizeCurve(e,s,{cpoints:[{x:e.x+l/2,y:e.y},{x:s.x-l/2,y:s.y}],props:f},m))};class ye extends L{get name(){return"mustache_lr"}render(e,t,s){const[i,o]=[t,s].map(p=>e.getNodeDimension(p)),r={src:t.$style.width*e.scale,dst:s.$style.width*e.scale},d=this.getRenderingOption(t),a=Ht(d)==="bottom";a&&t.firstChild()===s&&pe(e,t.$style,i,r.src);let l,u;const f=i.cx<=o.cx,m=a?"bottom":"cy";f?(l=_(i,m,"right",r.src/2),u=_(o,m,"left",r.dst/2)):(l=_(i,m,"left",r.src/2),u=_(o,m,"right",r.dst/2)),qt(e,l,t.$style,u,s.$style),(s.isFolded()||s.isLeaf())&&a&&pe(e,s.$style,o,r.dst)}}const Vt=(n,e,t,s,i,o)=>{const{scale:r}=n,d=e.$style.width*r,a=s.$style.width*r,l=Math.min(d,a),u=Math.abs(d-a);t.center.x-=u/2;const f={lineWidth:l,strokeStyle:s.$style.color},m=p=>{e.$style.dash&&p.setLineDash(e.$style.dash)};n.drawBeizeCurve(t.center,i.center,{cpoints:[{x:t.cx,y:t.cy+o/2},{x:i.cx,y:i.cy-o/2}],props:f},m),u>0&&(t.center.y+=u,n.drawBeizeCurve(t.center,i.center,{cpoints:[{x:t.cx,y:t.cy+o/2},{x:i.cx,y:i.cy-o/2}],props:f},m))};class ve extends L{get name(){return"mustache_tb"}render(e,t,s){const[i,o]=[t,s].map(u=>e.getNodeDimension(u)),r={hor:0,ver:5};let d,a;i.cy<=o.cy?(d=i,a=o):(d=o,a=i),d.center.y=d.bottom+r.ver,a.center.y=a.top-r.ver;const l=a.cy-d.cy;Vt(e,t,i,s,o,i===d?l:-l)}}const Ee=(n,e)=>{const t=[];return n.forEach((s,i)=>{e(s)&&t.push(i)}),t},Xt=n=>{n.registerEdgeRenderer(new fe),n.registerEdgeRenderer(new me),n.registerEdgeRenderer(new ye),n.registerEdgeRenderer(new ve)},we=(n,e)=>{n.children(t=>{const s=new V(n,t);e.push(s),we(t,e)})};class V{constructor(e,t){c(this,"srcNode");c(this,"dstNode");c(this,"visible");this.srcNode=e,this.dstNode=t,this.visible=!0}get src(){return this.srcNode}get dst(){return this.dstNode}matched(e){return this.srcNode===e||this.dstNode===e}matchedDst(e){return this.dstNode===e}}const xe=(n,e,t)=>{e.visible=t,n.filterEdges(i=>i.src===e.dst&&!i.src.isFolded()).forEach(i=>{xe(n,i,t)})};class be{constructor(e,t){c(this,"config");c(this,"canvas");c(this,"edges");c(this,"renderers",new Map);this.config=e,this.canvas=t,this.edges=[],this.config.listen(g.VIEWPORT.RESIZED,s=>{this.repaint()}).listen(g.NODE.MOVED,({node:s,prevParent:i})=>{this._deleteBetween(i,s),this._addEdge(s.parent,s),this.repaint()})}listRenderers(){return[...this.renderers.values()]}_addEdge(e,t){const s=new V(e,t);this.edges.push(s)}addEdge(e,t){this._addEdge(e,t),this.repaint()}_deleteBetween(e,t){return Ee(this.edges,i=>i.src===e&&i.dst===t).reverse().flatMap(i=>this.edges.splice(i,1))}deleteBetween(e,t){const s=this._deleteBetween(e,t);return s.length>0&&this.repaint(),s}deleteEdges(e){let t=0;e.forEach(s=>{const i=Ee(this.edges,o=>o.matched(e[0]));i.length>0&&i.reverse().forEach(o=>this.edges.splice(o,1)),t+=i.length}),t>0&&this.repaint()}setRootNode(e){this.edges=[],we(e,this.edges)}registerEdgeRenderer(e){const{name:t}=e;if(this.renderers.has(t))throw new Error(`duplicated edge name: [${t}]`);this.renderers.set(t,e)}filterEdges(e){return this.edges.filter(e)}setEdgeVisible(e,t,s=!0){this.filterEdges(o=>o.src===e).forEach(o=>{xe(this,o,t)}),s&&this.repaint()}repaint(e=!0){e&&this.canvas.clear(),this.edges.forEach(t=>{const{src:s,dst:i}=t,o=i.$style;t.visible&&this.renderers.get(o.name.toLowerCase()).render(this.canvas,s,i)})}dispose(){const{edges:e}=this;e.splice(0,e.length),this.repaint()}}const Kt={name:"line",option:{},color:"#000000",width:1,inherit:!0},T=(n,e)=>{let t=n,s=t.getStyle("edge");for(;(!s[e]||t!==n&&s.inherit===!1)&&!t.isRoot();)t=t.parent,s=t.getStyle("edge");return s[e]||Kt[e]};class Ce{constructor(e){c(this,"nodeUI");this.nodeUI=e}get name(){return T(this.nodeUI,"name")}get option(){return T(this.nodeUI,"option")}get color(){return T(this.nodeUI,"color")}get width(){const e=T(this.nodeUI,"width");if(typeof e=="function")return e(this.nodeUI.spec,this.nodeUI.level());if(typeof e=="number")return e;{const t=e;return Math.max(t.root+t.delta*this.nodeUI.level(),t.min)}}get dash(){return T(this.nodeUI,"dash")}getEdgeRenderer(){}}const De=n=>{const e=typeof n;return"number,string,boolean,undefined".includes(e)},Ne=n=>typeof n=="function",Yt=n=>n==null,X=n=>{if(n==null||De(n)||Ne(n))return n;const e=Array.isArray(n)?[]:{};return Object.keys(n).forEach(t=>{const s=X(n[t]);e[t]=s}),e},Se=(n,e)=>(Object.keys(n).forEach(t=>{Yt(e[t])?e[t]=X(n[t]):De(n[t])||Ne(n[t])?e[t]=n[t]:Se(n[t],e[t])}),e),v={deepCopy:X,mergeLeaf:Se};class Le{constructor(e,t){this.center=e,this._rect=t}get width(){return this._rect.width}get height(){return this._rect.height}get left(){return this.center.x-this._rect.width/2}get right(){return this.center.x+this._rect.width/2}get top(){return this.center.y-this._rect.height/2}get bottom(){return this.center.y+this._rect.height/2}get cx(){return this.center.x}get cy(){return this.center.y}get x(){return this.left}get y(){return this.top}get r(){return this.right}get b(){return this.bottom}merge(e){if(this===e)return this;const t=Math.min(this.left,e.left),s=Math.min(this.top,e.top),i=Math.max(this.right,e.right),o=Math.max(this.bottom,e.bottom);this.center.x=(i+t)/2,this.center.y=(o+s)/2;const r=i-t,d=o-s;return this._rect=new DOMRect(t,s,r,d),this}}const Gt=n=>{const{subs:e}=n.spec;return!e||e.length===0?[]:e.map(t=>{const s=new x(t,n.sharedConfig);return s.parent=n,s})};let jt=1;class x{constructor(e,t,s){c(this,"spec");c(this,"sharedConfig");c(this,"$el");c(this,"selected");c(this,"editing");c(this,"uid");c(this,"zIndex");c(this,"subs");c(this,"parent");c(this,"$style");c(this,"$dim");this.spec=e,this.sharedConfig=t,this.$el=void 0,this.selected=!1,this.editing=!1,this.uid=this.sharedConfig.ui.uuid(),this.zIndex=0,this.subs=Gt(this),this.parent=s,this.$style=new Ce(this),this.$dim=void 0}get model(){return v.deepCopy(this.spec.model)}get view(){const e=v.deepCopy(this.spec.view);return delete e.x,delete e.y,e}get $bodyEl(){return this.sharedConfig.getCanvas().getNodeBody(this)}get x(){return this.spec.view.x}get y(){return this.spec.view.y}get relativeOffset(){return new y(this.x,this.y)}get layout(){let{layout:e}=this.spec.view;return e?{...e}:this.parent&&this.parent.layout}get active(){return!!this.$el}get childNodes(){return[...this.subs]}get folding(){return this.spec.view.folding||!1}isReady(){return!!this.$el}dimension(e=!1){const t=this.$bodyEl,s=e?this.relativeOffset:this.offset();return this.$dim=new Le(s,this.sharedConfig.dom.domRect(t))}level(){return this.isRoot()?0:this.parent.level()+1}getStyle(e){return Object.assign({},this.spec.view[e])}isSelected(){return this.selected}setSelected(e){this.selected=e,this.zIndex=++jt,this.active&&this.selected!==e&&this.repaint()}isDescendantOf(e){let t=this;for(;t;){if(t===e)return!0;t=t.parent}return!1}updateModel(e){const{model:t}=this.spec;e(t)&&(this.$dim=null,this.sharedConfig.emit(g.NODE.UPDATED,{nodes:[this],type:"update"}))}getHeading(){return B.heading(new y(this.x,this.y))}offset(){let e=this;const t=new y(0,0);for(;e;)t.x+=e.x,t.y+=e.y,e=e.parent;return t}setOffset({x:e,y:t}){if(this.isRoot())return;const s=this.parent.offset();this.setPos(e-s.x,t-s.y)}getPos(){return new y(this.x,this.y)}setPos(e,t,s=!0){this.spec.view.x=e,this.spec.view.y=t,s&&this.repaint()}isEditingState(){return this.editing}setEditingState(e){this.editing=e,this.repaint()}isRoot(){return this.spec.root}isLeaf(){return this.subs.length===0}children(e){this.subs.forEach(t=>e(t,this))}find(e){if(e(this))return this;let t;for(let s=0;s<this.subs.length;s++)if(t=this.subs[s].find(e))return t}addChild(e){const t=e.parent;return t&&t!==this&&t.removeChild(e),e.parent=this,this.subs.push(e),this.sharedConfig.getCanvas().moveNode(e),t}removeChild(e){if(e.parent!==this)return null;const t=this.subs.findIndex(i=>i.uid===e.uid);if(t===-1)return null;const s=this.subs.splice(t,1);return s.forEach(i=>i.parent=void 0),s[0]}firstChild(){return this.subs[0]}lastChild(){if(this.subs.length!==0)return this.subs[this.subs.length-1]}setFolding(e){return this.folding===e?!1:(e?this.spec.view.folding=!0:delete this.spec.view.folding,this.repaint(),!0)}isFolded(){return this.folding}repaint(){this.sharedConfig.getCanvas().drawNode(this)}static build(e,t){return e.root=!0,new x(e,t)}}class Re{constructor(e){this.layoutContext=e}get name(){return"DEFAULT"}doLayout(e){}setPosition(){}}class Te{constructor(e){c(this,"doLayout",(e,t)=>{const{dir:s}=t;s&&(s.updated("LR")||s.updated("RL"))&&e.children(i=>{this._reverseXPos(i,t)})});c(this,"setPosition",(e,t)=>{const{baseNode:s}=t,o=(s?s.getHeading():e.parent.getHeading()).cwy<=180;let r=0,d=0,a=e.dimension(!0).width/2;if(s){const l=s.dimension(!0);o?r=l.left+a:r=l.right-a,d=l.bottom+20}else{const l=e.parent.dimension(!0),u=t.offset+a;o?r=l.width/2+u:r=-l.width/2-u}e.setPos(r,d)});this.layoutContext=e}get name(){return"X-AXIS"}_reverseXPos(e,t){const{x:s,y:i}=e;e.setPos(-s,i),this.layoutContext.getLayoutManager(e.layout).doLayout(e,t)}}class $e{constructor(e){c(this,"doLayout",(e,t)=>{const{dir:s}=t;s&&(s.updated("TB")||s.updated("BT"))&&e.children(i=>{this._reverseYPos(i,t)})});c(this,"setPosition",(e,t)=>{const{baseNode:s}=t,o=(s?s.getHeading():e.parent.getHeading()).ccwx<=180;let r=0,d=0;const a=e.dimension(!0);let l=a.height/2;if(s){const u=s.dimension(!0);r=u.cx+(u.width+a.width+t.offset)/2,o?d=u.bottom-l:d=u.top+l}else{const u=e.parent.dimension(!0),f=t.offset+l;r=0,o?d=-u.height/2-f:d=u.height/2+f}e.setPos(r,d)});this.layoutContext=e}get name(){return"Y-AXIS"}_reverseYPos(e,t){const{x:s,y:i}=e;e.setPos(s,-i),this.layoutContext.getLayoutManager(e.layout).doLayout(e,t)}}class Me{constructor(e){c(this,"setPosition",(e,t)=>{this.layoutContext.getLayoutManager({type:"X-AXIS"}).setPosition(e,t)});this.layoutContext=e}get name(){return"XY-AXIS"}doLayout(e,t){const{dir:s}=t;if(!s)return;this.layoutContext.getLayoutManager({type:"X-AXIS"}).doLayout(e,t),this.layoutContext.getLayoutManager({type:"Y-AXIS"}).doLayout(e,t)}}class _e{constructor(e){c(this,"_layoutMap",new Map);this.config=e}get canvas(){return this.config.getCanvas()}registerLayoutManager(e){this._layoutMap.set(e.name,e)}getLayoutManager(e){const t=e?e.type:"DEFAULT";return this._layoutMap.get(t)}setPosition(e,t){const{layout:s}=e;this.getLayoutManager(s).setPosition(e,t)}layout(e,t){const{layout:s}=e;this.getLayoutManager(s).doLayout(e,t)}listLayoutManagers(){return[...this._layoutMap.values()]}}const Oe=n=>{n.registerLayoutManager(new Re(n)),n.registerLayoutManager(new Te(n)),n.registerLayoutManager(new $e(n)),n.registerLayoutManager(new Me(n))};class ke{constructor(e,t){this.ctx=e,this.delegate=t}get name(){return this.delegate.name}_pickRenderer(){const{ctx:e}=this,{text:t,iconBadge:s,thumbnail:i}=this.delegate;let o="text";return t?o="text":s?o="icon-badge":i&&(o="thumbnail"),e.getEditor(o)}showEditor(e,t){return this._pickRenderer().showEditor(e,t)}}const Zt={editor:`<div class="mwd-node-editor thumbnail-editor">
    <div><input type="text" data-icon></div>
    <div><textarea data-text></textarea></div>
    <div><button data-close>CLOSE</button></div>
</div>`};class Ae{constructor(e){this.ctx=e}get name(){return"icon-badge"}showEditor(e,t){const{dom:s}=this.ctx.config,i=e["icon-badge"],o=this.ctx.parse(Zt.editor);{const r=s.findOne(o,"[data-icon]");r.value=i.icon,s.event.input(r,d=>{const a=d.target.value.trim();this.ctx.updateModel(()=>(i.icon=a,!1))},{debouce:500})}{const r=s.findOne(o,"[data-text]");r.value=i.text,s.event.input(r,d=>{const a=d.target.value.trim();this.ctx.updateModel(()=>(i.text=a,!1))},{debouce:500})}{const r=s.findOne(o,"[data-close]");s.event.click(r,()=>{this.ctx.close()})}return t.appendChild(o),o}}const Jt={editor:`<div class="mwd-node-editor link-editor">
    <div><input type="text" data-url></div>
    <div><input type="text" data-body></div>
    <div><button data-submit>UPDATE</button></div>
</div>`};class Pe{constructor(e){this.ctx=e}get name(){return"link"}showEditor(e,t){const{dom:s}=this.ctx.config,i=this.ctx.parse(Jt.editor),o=s.findOne(i,"[data-url]"),r=s.findOne(i,"[data-body]");{const{url:d,body:a}=e.link;o.value=d,r.value=a.text||d}return t.appendChild(i),s.event.click(i,d=>{const a=d.target;s.is(a,"[data-submit]")&&this.ctx.updateModel(l=>{const{link:u}=l;return u.url=o.value,u.body.text=r.value,!0})}),i}}const Qt={editor:`<div class="mwd-node-editor plain-text-editbox">
  <textarea value=""></textarea>
  <button data-cmd="save" data-submit>SAVE</button>
</div>`};class ze{constructor(e){this.ctx=e}get name(){return"text"}showEditor(e,t){const{dom:s}=this.ctx.config,i=this.ctx.parse(Qt.editor),o=this.ctx.query(i,"textarea");return o.value=e.text,s.css(o,{width:120,height:40}),s.event.click(i,r=>{r.target.dataset.cmd==="save"&&this.ctx.updateModel(d=>(d.text=o.value.trim(),!0))}),t.append(i),i}}const Ut={editor:`
  <div class="mwd-node-editor thumnail-editor">
    <div class="inline-mwd-form">
      <input type="text" data-form-size>
    </div>
    <div class="mode">
      <label><input type="radio" name="mode" data-mode="cover">Cover</label>
      <label><input type="radio" name="mode" data-mode="contain">Contain</label>
    </div>
    <div class="path-form">
        <textarea></textarea>
    </div>
    <div class=""><button data-close>CLOSE</button></div>
  </div>`};class We{constructor(e){this.ctx=e}get name(){return"thumbnail"}showEditor(e,t){if(!e.thumbnail)throw new Error("EDITOR_ERROR:not a thumbnail node");const{dom:s}=this.ctx.config,{mode:i,path:o}=e.thumbnail,r=this.ctx.parse(Ut.editor),d=this.ctx.query(r,"input");d.value=`${e.thumbnail.size}`,s.event.input(d,f=>{const m=f.target.value.trim();s.valid.number(m).then(p=>{this.ctx.updateModel(w=>(w.thumbnail.size=p,!1))})},{debouce:500});const a=this.ctx.query(r,`[data-mode="${i}"]`);a.checked=!0,s.event.change(r,f=>{const{mode:m}=f.target.dataset;m&&this.ctx.updateModel(p=>(p.thumbnail.mode=m,!1))});const l=this.ctx.query(r,"textarea");l.value=o,s.event.input(l,f=>{const m=f.target.value.trim();s.valid.path(m).then(p=>{this.ctx.updateModel(w=>(w.thumbnail.path=p,!1))})},{debouce:500});const u=this.ctx.query(r,"[data-close]");return s.event.click(u,()=>{this.ctx.close()}),t.appendChild(r),r}}const es=n=>{n.registerEditor(new ze(n)),n.registerEditor(new Ae(n)),n.registerEditor(new We(n)),n.registerEditor(new Pe(n))};class Be{constructor(e,t){c(this,"node");c(this,"_editorMap",new Map);this.canvas=e,this.datasourceFactory=t,this.node=void 0,this.config.listen(g.VIEWPORT.CLICKED,s=>{this.close()}),this.config.listen(g.NODE.SELECTED,({nodes:s})=>{this.node!==s[0]&&this.close()})}dispose(){this.node=void 0}get config(){return this.canvas.config}isEditing(){return!!this.node}registerEditor(e){this._editorMap.set(e.name,e)}registerCustomEditor(e){const t=new ke(this,e);this.registerEditor(t)}getEditor(e){return this._editorMap.get(e)}edit(e){this.node&&this.close();let t;const{model:s}=e;if(s.text)t="text";else if(s["icon-badge"])t="icon-badge";else if(s.thumbnail)t="thumbnail";else if(s.link)t="link";else if(s.provider){const o=this.datasourceFactory.findDataSourceByKey(s.provider.key);o&&(t=this.datasourceFactory.getEditorName(o.id))}const i=this._editorMap.get(t);i&&(this.node=e,this.node.setEditingState(!0),this.canvas.showNodeEditor(this.node,i))}parse(e){return this.config.dom.parseTemplate(e)}query(e,t){return this.config.dom.findOne(e,t)}queryAll(e,t){return this.config.dom.findAll(e,[t])}updateModel(e){let t=!1;this.node.updateModel(s=>(t=e(s),!0)),t&&this.close()}close(){this.node&&(this.node.setEditingState(!1),this.canvas.hideNodeEditor(this.node)),this.node=void 0}normalizeImageSize(e){let t,s;if(Array.isArray(e)){const[i,o]=e;t=`${i}px`,s=o===void 0?"auto":`${o}px`}else typeof e=="number"?t=s=`${e}px`:t=s="auto";return{width:t,height:s}}}class ts{constructor(e){this.resolvers=e}resolveLines(e,t){this.resolvers.forEach(s=>{s.resolveLines(e,t)})}}const Fe=(n,e,t,s,i)=>{if(n.includes(e))return;const o=i.getNodeDimension(e);t.add(o.y),t.add(o.cy),t.add(o.b),s.add(o.x),s.add(o.cx),s.add(o.r),!e.isFolded()&&e.subs.forEach(r=>{Fe(n,r,t,s,i)})};class ss{constructor(e,t,s){this.startingNode=e,this.nodes=t,this.canvas=s}resolveLines(e,t){Fe(this.nodes,this.startingNode,e,t,this.canvas)}}const Ie=(n,e,t,s,i,o)=>{if(n===void 0||o.includes(n)||e===0)return;const r=i.getNodeDimension(n);t.add(r.y),t.add(r.cy),t.add(r.b),s.add(r.x),s.add(r.cx),s.add(r.r),Ie(n.parent,e-1,t,s,i,o),!n.isFolded()&&n.subs.forEach(d=>{He(d,e-1,t,s,i,o)})},He=(n,e,t,s,i,o)=>{if(o.includes(n)||e===0)return;const r=i.getNodeDimension(n);t.add(r.y),t.add(r.cy),t.add(r.b),s.add(r.x),s.add(r.cx),s.add(r.r),!n.isFolded()&&n.subs.forEach(d=>{He(d,e-1,t,s,i,o)})};class ns{constructor(e,t,s){this.staringNodes=e,this.canvas=t,this.distance=s}resolveLines(e,t){const s=[...this.staringNodes];this.staringNodes.forEach(i=>{Ie(i.parent,this.distance,e,t,this.canvas,s)})}}const qe=n=>Math.abs(n),C=(n,e,t,s)=>{for(let i=0;i<n.length;i++){const o=n[i]-e,r=qe(o);r>s||r<qe(t.gap)&&(t.idx=i,t.gap=o)}},Ve=(n,e,t)=>{const s=e.snap;n.strokeStyle=s.color[t],n.lineWidth=s.width||.4,s.dash&&n.setLineDash(s.dash)};class Xe{constructor(e){c(this,"activeNodes");c(this,"snaps");this.config=e}_resolveSnapTarget(e){const{snap:t}=this.config.ui;if(t===!1)return;const s=t;if(s.enabled===!1)return;const{target:i}=s,o=this.config.getCanvas();if(i===void 0||i.length===0)return new ss(e,[...this.activeNodes],o);const r=i.map(d=>{if(d.distance)return new ns(this.activeNodes,o,d.distance)}).filter(d=>d!==void 0);return new ts(r)}turnOn(e,t){if(!t||t.length===0||!this.config.snapEnabled)return;this.activeNodes=[...t];const s=this._resolveSnapTarget(e);if(s===void 0)return;const i=new Set,o=new Set;s.resolveLines(o,i),this.snaps={hLines:o,vLines:i}}turnOff(){this.snaps=null,this.activeNodes=void 0}doAlign(){if(!this.snaps)return;const{snapSetting:e}=this.config,t=e.limit,s=this.config.getCanvas();s.clear();const i=s.getAbsoluteDimensions(this.activeNodes),o=[...this.snaps.vLines.values()].filter(a=>Math.abs(i.x-a)<=t||Math.abs(i.r-a)<=t||Math.abs(i.cx-a)<=t),r=[...this.snaps.hLines.values()].filter(a=>Math.abs(i.y-a)<=t||Math.abs(i.b-a)<=t||Math.abs(i.cy-a)<=t),d={x:0,y:0};if(o.length>0){const a={idx:0,gap:o[0]-i.cx};C(o,i.cx,a,t),C(o,i.x,a,t),C(o,i.r,a,t),d.x=a.gap,s.drawVLines([o[a.idx]],l=>Ve(l,this.config.ui,"vertical"))}if(r.length>0){const a={idx:0,gap:r[0]-i.cy};C(r,i.cy,a,t),C(r,i.y,a,t),C(r,i.b,a,t),d.y=a.gap,s.drawHLines([r[a.idx]],l=>Ve(l,this.config.ui,"horizontal"))}this.activeNodes.forEach(a=>{const l=a.offset();l.x+=d.x,l.y+=d.y,a.setOffset(l)})}}const K=n=>n,Ke=(n,e,t)=>{const s=e.toNodeConfigs(t,n);return n.childSetOf(e.name).forEach(o=>{Ke(n,o,e)}),s};class is{constructor(e,t,s,i){c(this,"name");c(this,"userDataList");c(this,"parentType");c(this,"callbacks");this.name=e,this.userDataList=t,this.parentType=s,this.callbacks=i}toNodeConfigs(e,t){let s=e?this.callbacks.relation:null;return this.userDataList.map((i,o)=>{const r={userData:i,subs:[]},{model:d}=this.callbacks;if(r.model=typeof d=="function"?d(i):v.deepCopy(d),s){const l=s(i,e.userDataList),u=t.$ref.get(l);r.idx=u.subs.length,u.subs.push(r)}const{view:a}=this.callbacks;return typeof a=="function"?r.view=a(i,r.idx):typeof a=="object"?r.view=v.deepCopy(a):r.view={x:0,y:0},t.$ref.set(i,r),r})}}class os{constructor(){c(this,"dataSets");c(this,"rootType");c(this,"$ref");this.dataSets=new Map,this.rootType=null,this.$ref=new Map}root(e,t,s){const i=[];return s?i.push(t):(s=t,i.push({})),s.virtual,this.rootType=e,s.relation=K,this.dataSet(e,i,s)}childSetOf(e){return[...this.dataSets.values()].filter(t=>t.parentType===e)}dataSet(e,t,s){const i={};i.relation=s.relation||K,i.model=s.model||K,i.view=s.view;const o=e.trim();if(this.dataSets.has(o))throw new Error(`[MIND WIRED] existing data type: [${e}]`);const r=new is(o,t,s.parent,i);return this.dataSets.set(o,r),this}build(){const e=this.dataSets.get(this.rootType);return Ke(this,e)[0]}}class Ye{constructor(e){c(this,"node");c(this,"prev");this.node=e,this.prev=void 0,this.capture()}get horizontal(){const{x:e}=this.node;return e<=0?-1:1}get vertical(){const{y:e}=this.node;return e<=0?-1:1}updated(e){const t=this.node.getHeading();if(e==="LR")return this.prev.cwy>180&&t.cwy<=180;if(e==="RL")return this.prev.cwy<=180&&t.cwy>180;if(e==="TB")return this.prev.ccwx<=180&&t.ccwx>180;if(e==="BT")return this.prev.ccwx>180&&t.ccwx<=180;throw new Error(`[${e}] is not allowed. use 'LR' | 'RL' | 'TB' | 'BT'`)}capture(){this.prev=this.node.getHeading()}}const Ge=(n,e)=>{n.set(e,e.getPos()),e.subs.forEach(t=>Ge(n,t))};class je{constructor(e){c(this,"pos");c(this,"dir");this.node=e,this.dir=new Ye(e),this.pos=e.getPos()}}class Ze{constructor(){c(this,"capture",new Map);c(this,"posMap",new Map)}prepareCaptures(e){this.clear(),e.filter(t=>!t.isRoot()).forEach(t=>{this.capture.set(t,new je(t)),Ge(this.posMap,t)})}eachCapture(e){for(let t of this.capture.values())e(t)}getUpdatedNodes(){let e=[];return this.posMap.forEach((t,s)=>{(t.x!==s.x||t.y!==s.y)&&e.push(s)}),e}clear(){this.capture.clear(),this.posMap.clear()}}const rs=(n=16)=>{let e="";for(;e.length<n;)e+=Math.random().toString(36).substring(2);return e.substring(0,n)};class Je{constructor(e,t,s){this.name=e,this.renderingContext=t,this.delegate=s}_pickRenderer(){const e=this.renderingContext,{text:t,iconBadge:s,thumbnail:i,link:o}=this.delegate;let r="text";return t?r="text":s?r="icon-badge":i?r="thumbnail":o&&(r="link"),e.getRenderer(r)}install(e,t){this._pickRenderer().install(e,t)}render(e,t,s){this._pickRenderer().render(e,t,s)}editor(e){throw new Error("Method not implemented.")}}const ds={text:'<span class="mwd-node-text"></span>',editor:`<div class="mwd-node-editor plain-text-editbox">
    <textarea value=""></textarea>
    <button data-cmd="save">SAVE</button>
  </div>`};class Qe{constructor(e){c(this,"ctx");this.ctx=e}install(e,t){const s=this.ctx.parse(ds.text);t.append(s)}render(e,t){const s=this.ctx.query(t,".mwd-node-text"),i=e.text.split(`
`).map(o=>`<p>${o}</p>`).join("");s.innerHTML=i}get name(){return"text"}}const as={viewer:`<div class="icon-badge-node">
    <img>
    <span class="mwd-node-text"></span>
  </div>`,editor:'<div class=""></div>'};class Ue{constructor(e){c(this,"ctx");this.ctx=e}get name(){return"icon-badge"}install(e,t){const s=this.ctx.parse(as.viewer);t.append(s)}render(e,t){const{icon:s,text:i}=e["icon-badge"],o=this.ctx.query(t,"img");o.src=s;const r=this.ctx.query(t,".mwd-node-text");r.innerText=i}}const cs={viewer:'<div class="mwd-thumbnail-node"></div>'};class et{constructor(e){c(this,"ctx");this.ctx=e}get name(){return"thumbnail"}install(e,t){const s=this.ctx.parse(cs.viewer);t.append(s)}render(e,t){const s=this.ctx.query(t,".mwd-thumbnail-node"),{size:i,mode:o}=e.thumbnail,{width:r,height:d}=this.ctx.normalizeImageSize(i);this.ctx.css(s,{"background-image":`url("${e.thumbnail.path}")`,"background-size":o||"cover",width:r,height:d}),s.classList.add("cover")}}const ls={link:`
  <div class="mwd-link-node">
    <a data-url data-mwd-link></a>
    <span data-mwd-link-opener><a target="_" data-mwd-link></a></span>
  </div>`};class tt{constructor(e){this.ctx=e}get name(){return"link"}install(e,t){const s=this.ctx.parse(ls.link),{body:i}=e.link,o=this.ctx.getRenderer(i.type||"text"),r=this.ctx.query(s,"a");o.install(e,r),t.append(s)}render(e,t,s){const{url:i,body:o}=e.link,r=this.ctx.query(t,"a");r.dataset.url=i;{const a=this.ctx.query(t,"[data-mwd-link-opener]");s.selected?a.classList.add("visible"):a.classList.remove("visible");const l=this.ctx.query(a,"a");l.href=i,l.textContent=i}this.ctx.getRenderer(o.type||"text").render(o,r)}}const $=new Map,hs=n=>(n.register(new Qe(n)),n.register(new Ue(n)),n.register(new et(n)),n.register(new tt(n)),n);class st{constructor(e,t){c(this,"editingNode");c(this,"canvas");c(this,"uid");this.datasourceFactory=t,this.canvas=e,this.uid=`node-rctx-${rs()}`,$.set(this.uid,new Map),this.editingNode=null}get event(){return this.canvas.dom.event}get valid(){return this.canvas.dom.valid}parse(e,t=!1){const{dom:s}=this.canvas,i=s.parseTemplate(e);return t&&s.css(i,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}),i}register(e){$.get(this.uid).set(e.name,e)}registerCustomRender(e){const t=new Je(e.name,this,e);this.register(t)}getRendererByModel(e){let t;if(e.text)t="text";else if(e.thumbnail)t="thumbnail";else if(e["icon-badge"])t="icon-badge";else if(e.link)t="link";else if(e.provider){const i=this.datasourceFactory.findDataSourceByKey(e.provider.key);i&&(t=this.datasourceFactory.getRendererName(i.id))}const s=$.get(this.uid).get(t);if(!s)throw new Error(`no match node renderer found for ModelSpec: ${JSON.stringify(e)}`);return s}getRenderer(e){const t=$.get(this.uid).get(e||"text");if(!t)throw new Error(`[No Renderer] no such renderer, (type:${e})`);return t}listRenderers(){return[...$.get(this.uid).values()]}select(e,t){return e.$bodyEl.querySelector(t)}css(e,t){this.canvas.dom.css(e,t)}query(e,t){return this.canvas.dom.findOne(e,t)}normalizeImageSize(e){let t,s;if(Array.isArray(e)){const[i,o]=e;t=`${i}px`,s=o===void 0?"auto":`${o}px`}else typeof e=="number"?t=s=`${e}px`:t=s="auto";return{width:t,height:s}}dispose(){this.editingNode=void 0}}const Y=n=>{const e=[...n.values()];return e.forEach(t=>{t.setSelected(!1)}),n.clear(),e},nt=n=>!!(n.length!==1||n[0].isEditingState()),us=n=>n.length===0?!0:!!n.find(t=>t.isRoot()),it=(n,e,t)=>{const s=n.config.mindWired();let i=t?v.deepCopy(t.spec.model):{text:"Text Node"};s.addNode(e,{model:i,view:void 0},{siblingNode:t})},gs=(n,e)=>{n.config.mindWired().deleteNodes(e)},G=(n,e)=>{const{config:t}=n,s=n.getNodes();setTimeout(()=>t.emit(g.NODE.SELECTED.CLIENT,{nodes:s,append:e,type:"select"}))};class ot{constructor(e){c(this,"config");c(this,"nodeMap");this.config=e,this.nodeMap=new Map;const t=this.config.getCanvas();this.config.listen(g.NODE.SELECTED,({nodes:i,append:o})=>{this.selectNodes(i,o,!0)}),this.config.listen(g.VIEWPORT.CLICKED,()=>{this.clearSelection()});const{dom:s}=this.config;s.event.keyup(t.$viewport,i=>{if(this.isEmpty())return;const{code:o}=i,[r]=[...this.nodeMap.values()],d=r.isEditingState();o==="Space"&&!d?(i.stopPropagation(),t.clearNodeSelection(),this.config.emit(g.NODE.EDITING,{editing:!0,node:r})):o==="Escape"&&this.config.emit(g.NODE.EDITING,{editing:!1,node:r})}),s.event.keydown(t.$viewport,i=>{const o=this.getNodes();nt(o)||(i.stopPropagation(),i.stopImmediatePropagation(),it(this,o[0].parent,o[0]))},"enter"),s.event.keydown(t.$viewport,i=>{const o=this.getNodes();nt(o)||(i.stopPropagation(),i.stopImmediatePropagation(),it(this,o[0],o[0].lastChild()))},"shift@enter"),s.event.keydown(t.$viewport,i=>{const o=this.getNodes();us(o)||(i.stopPropagation(),i.stopImmediatePropagation(),gs(this,o),Y(this.nodeMap),G(this,!1))},"delete")}selectNodes(e,t,s=!1){const i=e.filter(o=>!this.nodeMap.has(o.uid));return i.length===0||(t||Y(this.nodeMap),i.forEach(o=>{this.nodeMap.set(o.uid,o),o.setSelected(!0)}),s&&G(this,t)),i}isEmpty(){return this.nodeMap.size===0}getNodes(){return[...this.nodeMap.values()]}clearSelection(){const e=Y(this.nodeMap);return e.length>0&&(this.config.getCanvas().clearNodeSelection(),G(this,!1)),e}}class rt{constructor(e,t){c(this,"_items",[]);c(this,"_itemMap",new Map);this.id=e,this.keyOf=t}getData(e){return this._itemMap.get(e)}setData(e){e.forEach(t=>{const s=this.keyOf(t),i=this._itemMap.get(s);if(i)throw new Error(`duplicated item found: key[${s}], value is ${i}`);this._itemMap.set(s,t)}),this._items.push(...e)}containsData(e){const t=this.keyOf(e);return this.containsKey(t)}containsKey(e){return this._itemMap.has(e)}}class dt{constructor(){c(this,"_dsMap",new Map);c(this,"_dsToRendererMap",new Map);c(this,"_dsToEditorMap",new Map)}createDataSource(e,t){if(this._dsMap.has(e))throw new Error(`duplicated datasource id: [${e}]`);const s=new rt(e,t);return this._dsMap.set(e,s),s}getDataSource(e){return this._dsMap.get(e)}bindRendererMapping(e,t){this._dsToRendererMap.set(e.id,t)}getRendererName(e){return this._dsToRendererMap.get(e)}bindEditorMapping(e,t){this._dsToEditorMap.set(e.id,t)}getEditorName(e){return this._dsToEditorMap.get(e)}findDataSourceByData(e){return this._findBy(t=>t.containsData(e))}findDataSourceByKey(e){return this._findBy(t=>t.containsKey(e))}_findBy(e){const t=[...this._dsMap.values()];for(let s=0;s<t.length;s++){const i=t[s];if(e(i))return i}}findData(e){return this._findBy(s=>s.containsKey(e)).getData(e)}clear(){this._dsToRendererMap.clear(),this._dsToEditorMap.clear(),this._dsMap.clear()}}const fs=()=>{},ms=(n,e)=>{n.update(t=>(e(t),t))};class at{constructor(){}subscribe(e){return this.store.subscribe(e)}update(e){ms(this.store,e||fs)}}function j(){}function ps(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}const D=[];function ys(n,e=j){let t;const s=new Set;function i(d){if(ps(n,d)&&(n=d,t)){const a=!D.length;for(const l of s)l[1](),D.push(l,n);if(a){for(let l=0;l<D.length;l+=2)D[l][0](D[l+1]);D.length=0}}}function o(d){i(d(n))}function r(d,a=j){const l=[d,a];return s.add(l),s.size===1&&(t=e(i,o)||j),d(n),()=>{s.delete(l),s.size===0&&t&&(t(),t=null)}}return{set:i,update:o,subscribe:r}}const ct={overwriteIfExist:!1,skipEvent:!1};class lt extends at{constructor(t,s=new Map){super();c(this,"store");c(this,"_eventRef",{detail:void 0});this._config=t,this._map=s,this.store=ys(this._eventRef)}get canvas(){return this._config.getCanvas()}_notify(t){this._eventRef.detail=t,this.update(),this._eventRef.detail=void 0}findSchema(t){return this.getSchemas().find(t)}addSchema(t,s=ct){const i=this._map.has(t.name);if(i&&!s.overwriteIfExist)throw new Error(`schema [${t.name}] exists.`);this._map.set(t.name,t),this._registerSchema(t),s.skipEvent||this._notify({type:i?"update":"create",schemas:[t]})}_registerSchema(t){this.canvas.drawSchema(t)}getSchemas(){return[...this._map.values()]}removeSchema(t,s=ct){const i=typeof t=="string"?t:t.name,o=this._map.get(i);o&&(this.canvas.removeSchema(o.name),this._map.delete(o.name),s.skipEvent||this._notify({type:"delete",schemas:[o]}))}dispose(){for(const t of this._map.values())this.removeSchema(t,{skipEvent:!0})}}class O{static has(e,t){const{schema:s}=e;return s?s.split(" ").filter(o=>o.length>0).includes(t.name):!1}static toSchema(e,t){return typeof e=="string"?t.findSchema(s=>s.name===e):e}}const vs={types:["node","schema","ui"]};class ht{constructor(e){this.mwd=e}async export(e=vs){const t={},s=new Set(e.types);if(s.has("node")&&(t.node=v.deepCopy(await this.mwd.export(!1))),s.has("schema")){const i=this.mwd.getSchemaContext();t.schema=v.deepCopy(i.getSchemas())}return s.has("ui")&&(t.ui=v.deepCopy(this.mwd.config.ui),delete t.ui.offset),Promise.resolve(t)}}const ut=(n,e)=>{const t=e.spec.view,s={x:t.x,y:t.y,layout:void 0,folding:void 0,style:void 0},i=e.isRoot();let o=i?n.ui.offset.x:t.x,r=i?n.ui.offset.y:t.y;s.x=Math.floor(10*o)/10,s.y=Math.floor(10*r)/10,t.layout&&(s.layout=t.layout),t.edge&&(s.edge=t.edge),t.folding&&(s.folding=!0),t.style&&(s.style=t.style);const d=[];return e.subs.forEach(a=>{d.push(ut(n,a))}),{model:e.model,view:s,subs:d.length>0?d:void 0}},Z=(n,e,t=!0)=>{e.repaint(),t&&e.subs.forEach(s=>{Z(n,s)}),e.isFolded()&&n.setFoldingState([e],!0)},J=(n,e,t)=>{const s=t.nodeLevelClassName(n);t.dom.clazz[e](n.$bodyEl,s),n.subs.forEach(i=>J(i,e,t))},Es=(n,e)=>e?(v.mergeLeaf(n,e),e):n;class gt{constructor(e){c(this,"config");c(this,"canvas");c(this,"nodeRenderingContext");c(this,"nodeSelectionModel");c(this,"_nodeLayoutContext");c(this,"nodeEditingContext");c(this,"_alignmentContext");c(this,"dragContext");c(this,"_edgeContext");c(this,"rootUI");c(this,"_dsFactory");c(this,"_schemaContext");this.config=e,e.mindWired=()=>this,this.canvas=new ge(e),e.getCanvas=()=>this.canvas,this._dsFactory=new dt,e.getNodeRenderer=()=>this.nodeRenderingContext,this.nodeSelectionModel=new ot(e),this._nodeLayoutContext=new _e(e),Oe(this._nodeLayoutContext),this.nodeRenderingContext=new st(this.canvas,this._dsFactory),hs(this.nodeRenderingContext),this.nodeEditingContext=new Be(this.canvas,this._dsFactory),es(this.nodeEditingContext),this._alignmentContext=new Xe(e),this.dragContext=new Ze,this._edgeContext=new be(e,this.canvas),Xt(this._edgeContext),this._schemaContext=new lt(e),this._schemaContext.subscribe(t=>{if(t.detail){const{detail:s}=t;setTimeout(()=>{this._edgeContext.repaint(!0);const{type:i}=s,o=i==="create"?"CREATED":i==="update"?"UPDATED":"DELETED";this.config.emit(g.SCHEMA[o].CLIENT,s)})}}),this.config.listen(g.DRAG.VIEWPORT,t=>{if(this.config.setOffset(t.offset),this.canvas.repaintNodeHolder(),this._edgeContext.repaint(),t.state==="done"){this.rootUI.setPos(t.offset.x,t.offset.y,!1);try{this.config.emit(g.NODE.UPDATED.CLIENT,{nodes:[this.rootUI],type:"pos"})}finally{this.rootUI.setPos(0,0)}}}).listen(g.DRAG.NODE,t=>{if(t.state==="ready"){const s=this.nodeSelectionModel.getNodes(),i=t.target==="all"?s:s.flatMap(o=>o.subs);this.dragContext.prepareCaptures(i),this._alignmentContext.turnOn(this.rootUI,i),this.canvas.updateSelection(s)}else if(t.state==="drag"){const s=t.target==="all"?1:2.5;this.dragContext.eachCapture(i=>{const{node:o,dir:r,pos:d}=i;r.capture(),o.setPos(s*t.x+d.x,s*t.y+d.y,!this.config.snapEnabled)}),this._alignmentContext.doAlign(),this.dragContext.eachCapture(i=>{const{node:o,dir:r}=i;this._nodeLayoutContext.layout(o,{dir:r})}),this.canvas.updateSelection(this.nodeSelectionModel.getNodes()),this._edgeContext.repaint(!this.config.snapEnabled)}else if(t.state==="done"){this._alignmentContext.turnOff(),this._edgeContext.repaint(!0);const s=this.dragContext.getUpdatedNodes();if(s.length>0)this.config.emit(g.NODE.UPDATED.CLIENT,{nodes:s,type:"pos"});else{const i=this.nodeSelectionModel.getNodes();this.config.emit(g.NODE.CLICKED.CLIENT,{nodes:i,type:"click"})}this.dragContext.clear()}}).listen(g.NODE.EDITING,({editing:t,node:s})=>{t?this.nodeEditingContext.edit(s):this.nodeEditingContext.close()}).listen(g.NODE.UPDATED,({nodes:t})=>{t.forEach(s=>s.repaint()),this._edgeContext.repaint(),this.config.emit(g.NODE.UPDATED.CLIENT,{nodes:t,type:"model"})})}getAligmentContext(){return this._alignmentContext}createDataSource(e,t,s){const i=this._dsFactory.createDataSource(e,t);if(s){const{renderer:o,editor:r}=s;o&&(this.nodeRenderingContext.registerCustomRender(o),this._dsFactory.bindRendererMapping(i,o.name)),r&&(this.nodeEditingContext.registerCustomEditor(r),this._dsFactory.bindEditorMapping(i,r.name))}return i}isEditing(){return this.nodeEditingContext.isEditing()}_dispose(){this.nodeRenderingContext.dispose(),this.nodeEditingContext.dispose(),this._dsFactory.clear(),this._edgeContext.dispose(),this._alignmentContext.turnOff(),this.dragContext.clear(),this.canvas.unregisterNodeTree(this.rootUI)}nodes(e){if(this.rootUI&&this._dispose(),e instanceof os){const t=e.build();this.rootUI=x.build(t,this.config)}else e&&(this.rootUI=x.build(e,this.config));return this._edgeContext.setRootNode(this.rootUI),this.config.ui.offset.x=this.rootUI.spec.view.x,this.config.ui.offset.y=this.rootUI.spec.view.y,this.rootUI.spec.view.x=0,this.rootUI.spec.view.y=0,this.repaint(),this}findNode(e){return this.rootUI.find(e)}addNode(e,t,s){const i={root:!1,model:t.model,view:t.view};i.view||(i.view={x:0,y:0});const o=e.lastChild(),r=new x(i,this.config,e);return this.canvas.regsiterNode(r),e.addChild(r),r.repaint(),this._nodeLayoutContext.setPosition(r,{baseNode:o,offset:60}),this._edgeContext.addEdge(r.parent,r),this.config.emit(g.NODE.CREATED.CLIENT,{nodes:[r],type:"create"}),r}moveNodes(e,t,s=!1){const i=t.filter(o=>o.parent!==e);i.forEach(o=>{J(o,"remove",this.config);const r=e.addChild(o);J(o,"add",this.config),this.config.emit(g.NODE.MOVED,{node:o,prevParent:r})}),e.setFolding(!1),Z(this,e),this.canvas.updateSelection(t),s&&this.config.emit(g.NODE.UPDATED.CLIENT,{nodes:i,type:"path"})}deleteNodes(e){const t=[],s=[];e.forEach(i=>{const{parent:o,childNodes:r}=i;r.length>0&&(r.forEach(a=>{a.setPos(a.x+i.x,a.y+i.y)}),this.moveNodes(o,r),t.push(...r.filter(a=>!e.includes(a))));const d=i.parent.removeChild(i);d&&(this.canvas.unregisterNode(d),s.push(i))}),t.length>0&&this.config.emit(g.NODE.UPDATED.CLIENT,{nodes:t,type:"path"}),s.length>0&&(this._edgeContext.deleteEdges(s),this.config.emit(g.NODE.DELETED2.CLIENT,{nodes:s,updated:t,type:"delete"}))}getNodeSelectionModel(){return this.nodeSelectionModel}getSelectedNodes(){return this.nodeSelectionModel.getNodes()}setLayout(e,t){const s=t||this.rootUI;e?s.spec.view.layout=e:delete s.spec.view.layout,this.repaint()}setEdge(e,t){const s=t||this.rootUI;e?s.spec.view.edge=Es(e,s.spec.view.edge):delete s.spec.view.edge,this.repaint(t)}setScale(e){this.config.ui.scale=e,this.repaint()}setFoldingState(e,t){const s=e.filter(i=>{const o=i.setFolding(t);return this.canvas.updateFoldingNodes(i),this._edgeContext.setEdgeVisible(i,!t,!1),o});this._edgeContext.repaint(),this.config.emit(g.NODE.UPDATED.CLIENT,{type:"folding",nodes:s})}repaint(e){e=e||this.rootUI,Z(this,e),this.canvas.repaintNodeHolder(),this._nodeLayoutContext.layout(e,{dir:void 0}),this._edgeContext.repaint(),this.canvas.clearNodeSelection(),this.canvas.updateSelection(this.getSelectedNodes())}listen(e,t){const s=Ct(`${e}.client`);return this.config.ebus.listen(s,t),this}listenStrict(e,t){e===g.NODE.DELETED&&(e=g.NODE.DELETED2);const s=e.CLIENT||e;return this.config.ebus.listen(s,t),this}getNodeRender(e){return this.nodeRenderingContext.getRendererByModel(e)}listNodeRenderers(){return this.nodeRenderingContext.listRenderers()}listEdgeRenderers(){return this._edgeContext.listRenderers()}listNodeLayoutManagers(){return this._nodeLayoutContext.listLayoutManagers()}translateModel(e){if(e.provider){const{key:t}=e.provider,s=this._dsFactory.findDataSourceByKey(t),i=s.getData(t),o=this._dsFactory.getRendererName(s.id),r=this.nodeRenderingContext.getRenderer(o),{text:d,iconBadge:a,thumbnail:l,link:u}=r.delegate;let f;return d?f={type:"text",text:d(i)}:a?f={type:"icon-badge","icon-badge":a(i)}:l?f={type:"thumbnail",thumbnail:l(i)}:u&&(f={type:"link",link:u(i)}),f}else return e}export(e=!0){const t=ut(this.config,this.rootUI),s=e?JSON.stringify(t):t;return Promise.resolve(s)}exportWith(e){return new ht(this).export(e)}registerEdgeRenderer(e){this._edgeContext.registerEdgeRenderer(e)}getSchemaContext(){return this._schemaContext}registerSchema(e){this._schemaContext.addSchema(e)}bindSchema(e,t){if(t=t||this.getSelectedNodes(),t.length===0)return;const s=O.toSchema(e,this._schemaContext),i=t.filter(o=>this._bindSchema(s,o,!0));this._notifySchemaBinding(i)}unbindSchema(e,t){if(t=t||this.getSelectedNodes(),t.length===0)return;const s=O.toSchema(e,this._schemaContext),i=t.filter(o=>this._bindSchema(s,o,!1));this._notifySchemaBinding(i)}toggleSchema(e,t){if(t=t||this.getSelectedNodes(),t.length===0)return;const s=O.toSchema(e,this._schemaContext),i=t.filter(o=>{const r=O.has(o.spec.model,s);return this._bindSchema(s,o,!r)});this._notifySchemaBinding(i)}_notifySchemaBinding(e){e.length>0&&setTimeout(()=>{this._edgeContext.repaint(!0),this.config.emit(g.NODE.UPDATED.CLIENT,{type:"schema",nodes:e})})}_bindSchema(e,t,s){return s?this.canvas.bindSchema(t,e):this.canvas.unbindSchema(t,e)}}let ws=1e3;const ft={width:600,height:600,scale:1,uuid:()=>`uuid-${ws++}`,clazz:{node:"active-node",edge:"active-edge",schema:n=>n,level:n=>`level-${n}`,folded:"folded"},styleDef:{schema:{styleId:"#mwd-schema-@schema@mapId",selector:"[data-mind-wired-viewport@mapId] .mwd-node.@schema > .mwd-body"}},offset:new y(0,0),snap:{limit:4,width:.4,dash:[6,2],color:{horizontal:"orange",vertical:"#2bc490"}},selection:{padding:5,"background-color":"#b3ddff6b","border-radius":"4px"},useDefaultIcon:!0};class k{constructor({el:e,ui:t,dom:s,eventBus:i}){c(this,"el");c(this,"ui");c(this,"ebus");c(this,"dom");c(this,"mindWired");c(this,"model");c(this,"view");c(this,"subs");c(this,"getCanvas");c(this,"getNodeRenderer");this.el=e,this.ui=t,this.dom=s,this.ebus=i||new Dt}get width(){return this.ui.width}get height(){return this.ui.height}get scale(){return this.ui.scale}get snapEnabled(){return this.ui.snap.enabled}get snapSetting(){return this.ui.snap}getOffset(){return this.ui.offset.clone()}setOffset(e){this.ui.offset=e.clone()}relativeOffset(e){return this.ui.offset.sum(e)}activeClassName(e){const t=this.ui.clazz[e];if(!t)throw new Error(`[MINDWIRED][ERROR] no classname of type : "${e}"`);return t}nodeLevelClassName(e){const{level:t}=this.ui.clazz;let s;return typeof t=="string"?s=t:typeof t=="function"?s=t(e.level(),e.spec):s=`level-${e.level()}`,s}foldedNodeClassName(){return this.ui.clazz.folded||"folded"}listen(e,t){return this.ebus.on(e,t),this}off(e,t){this.ebus.off(e.name,t)}emit(e,t){return this.ebus.emit(e,t),this}static parse(e,t,s){const i=v.mergeLeaf(e.ui||{},v.deepCopy(ft));xs(i),bs(i,t);const o=typeof e.el=="string"?document.querySelector(e.el):e.el;return new k({el:o,ui:i,dom:t,eventBus:s})}}const xs=n=>{const{offset:e}=n;e instanceof y||(n.offset=new y(n.offset.x,n.offset.y))},bs=(n,e)=>{const{snap:t}=n,s=ft.snap;if(t===!1)n.snap=v.deepCopy(s),n.snap.enabled=!1;else{if(e.valid.string(t.color)){const i=t.color;t.color={horizontal:i.trim(),vertical:i.trim()}}t.limit=t.limit||s.limit,t.width=t.width||s.width,t.dash!==!1&&(t.dash=t.dash||s.dash),t.enabled===void 0&&(t.enabled=!0)}};class Cs{constructor(e){c(this,"expression");this.expression=e}get isClass(){return this.expression.charAt(0)==="."}get isId(){return this.expression.charAt(0)==="#"}get value(){return this.expression.substring(1)}setAttribute(e){if(this.isId)e.setAttribute("id",this.value);else if(this.isClass)e.classList.add(this.value);else throw new Error(`neither id nor class : [${this.expression}]`)}}const mt=(n,e)=>{var t;if(n.nodeType===1)return n.closest(e);if(n.nodeType===3)return(t=n.parentElement)==null?void 0:t.closest(e);throw new Error(`node type ${n.nodeType}, tag(${n.nodeName})`)},M=n=>(n||"").split(" ").map(t=>t.trim()).filter(t=>t.length>0),N=(n,e)=>{const t=document.createElement(n);return e&&e.forEach(s=>{new Cs(s).setAttribute(t)}),t},Ds={span:(n,e)=>{const t=N("span",M(n));return e&&(t.innerHTML=e),t},iconButton:(n,e)=>{const t=N("BUTTON",M(n));return t.innerHTML=e,t},img:n=>{const e=N("img");return new Promise((t,s)=>{e.onload=()=>{t({img:e,width:e.naturalWidth,height:e.naturalHeight})},e.onerror=()=>{console.log("ERROR"),s("NOT_ALLOWED")},e.crossOrigin="Anonymous",e.src=n})},div:n=>N("DIV",M(n)),style:n=>N("STYLE",M(n)),canvas:n=>N("CANVAS",M(n))},Ns=(n,e,t,s)=>{const i=n.getAttribute(e);(s||!i)&&n.setAttribute(e,t)},Ss={add:(n,e)=>n.classList.add(e),remove:(n,e)=>n.classList.remove(e)},A=(n,e,t,s)=>{(n||globalThis).addEventListener(e,t,!1)},pt=(n,e,t,s)=>{n.addEventListener(e,i=>{const o=i.code.toLowerCase(),{keys:r}=s;for(let d=0;d<r.length;d++){const a=r[d],{ctrlKey:l,shiftKey:u,altKey:f,metaKey:m}=i;if(a.code==="*"||a.code===o&&a.alt===f&&a.meta===m&&a.shift===u&&a.ctrl===l){t(i);break}}},!1)},yt=n=>{let[e,t]=n.split("@");t||(t=e,e="");const s=e.split("+");return{ctrl:s.includes("ctrl"),shift:s.includes("shift"),alt:s.includes("alt"),meta:s.includes("meta"),code:t}},Ls={int:(n,e)=>{const t={};return e.forEach(s=>{const i=n.dataset[s]||"";t[s]=parseInt(i,10)}),t}},Rs=n=>n.stopPropagation(),Ts={consume:(n,e)=>{n.addEventListener(e,Rs)},click:(n,e,t)=>{A(n,"click",e)},keydown:(n,e,t)=>{t=t||"*";const s=t.split(" ").filter(i=>i.trim().length>0).map(i=>yt(i));pt(n,"keydown",e,{keys:s})},keyup:(n,e,t)=>{t=t||"*";const s=t.split(" ").filter(i=>i.trim().length>0).map(i=>yt(i));pt(n,"keyup",e,{keys:s})},input:(n,e,t)=>{if((t==null?void 0:t.debouce)>0){let s;A(n,"input",i=>{clearTimeout(s),s=setTimeout(e,t.debouce,i)})}else A(n,"input",e)},change:(n,e)=>{A(n,"change",e)}},Q={width:n=>typeof n==="number"?`${n}px`:""+n};"top,left,height,minWidth,minHeight".split(",").forEach(n=>{Q[n]=Q.width});const $s=(n,e)=>{Object.keys(e).forEach(t=>{const i=(Q[t]||(o=>o))(e[t]);n.style[t]=i})},Ms=(n,e)=>{let t=n;Object.keys(e||{}).forEach(i=>{const o="@"+i,r=e[i];t=t.replaceAll(o,r)});const s=document.createElement("template");return s.innerHTML=t,s.content.firstElementChild},_s=(n,e)=>n.querySelector(e),Os=(n,e)=>e.reduce((t,s)=>(n.querySelectorAll(s).forEach(o=>{t.push(o)}),t),[]),ks=(n,e,t=!0)=>{const s=n.matches(e);return s||(t?!!mt(n,e):!1)},As=n=>n.getBoundingClientRect(),Ps={method:n=>typeof n=="function"},zs={path:n=>new Promise((e,t)=>{const s=n&&n.trim();s.length>0?e(s):t(n)}),number:n=>new Promise((e,t)=>{const s=Number.parseFloat(n);Number.isNaN(s)?t(n):e(s)}),string:n=>typeof n=="string"&&n.trim().length>0};class vt{constructor(){c(this,"tag");c(this,"attr");c(this,"clazz");c(this,"closest");c(this,"event");c(this,"css");c(this,"parseTemplate");c(this,"findOne");c(this,"findAll");c(this,"is");c(this,"data");c(this,"domRect");c(this,"types");c(this,"valid");this.tag=Ds,this.attr=Ns,this.clazz=Ss,this.closest=mt,this.event=Ts,this.css=$s,this.parseTemplate=Ms,this.findOne=_s,this.findAll=Os,this.is=ks,this.data=Ls,this.domRect=As,this.types=Ps,this.valid=zs}renderStyle(e,t,s=!0){if(s)for(let i=e.style.length-1;i>=0;i--){const o=e.style[i];e.style.removeProperty(o)}Object.keys(t).forEach(i=>{const o=t[i];o&&(e.style[i]=o)})}}let Ws;const Bs=()=>Ws,Fs=(n,e)=>{const t=e.tag.canvas();return n.append(t),t},Is=n=>{const e=document.querySelector("[mind-wired-holder]");e&&(n.findOne(e,"canvas")||Fs(e,n))},Et=n=>new Promise((e,t)=>{const s=new vt,{el:i}=n;if(i){window.addEventListener("DOMContentLoaded",()=>{Is(s)});const o=k.parse(n,s);o.dom=s;const r=new gt(o);if(n.schema){const d=r.getSchemaContext();n.schema.forEach(a=>{d.addSchema(a,{skipEvent:!0})})}e(r)}else t({cause:"no_css_selector"})}),Hs=Et;h.AbstractEdgeRenderer=L,h.AlignmentContext=Xe,h.BaseDataSource=rt,h.CanvasUI=ge,h.Capture=je,h.Configuration=k,h.DataSourceFactory=dt,h.DefaultNodeLayout=Re,h.Direction=Ye,h.DomUtil=vt,h.DragContext=Ze,h.EVENT=g,h.Edge=V,h.EdgeContext=be,h.EdgeStyle=Ce,h.ExportContext=ht,h.Geometry=le,h.Heading=ce,h.IconBadgeEditor=Ae,h.IconBadgeRenderer=Ue,h.LineEdgeRenderer=fe,h.LinkEditor=Pe,h.LinkRenderer=tt,h.MindWired=gt,h.MindWiredStore=at,h.MustacheLREdgeRenderer=ye,h.MustacheTBEdgeRenderer=ve,h.NaturalCourveEdgeRenderer=me,h.NodeEditingContext=Be,h.NodeEditingDelegate=ke,h.NodeLayoutContext=_e,h.NodeRect=Le,h.NodeRenderingContext=st,h.NodeSelectionModel=ot,h.NodeUI=x,h.PlainTextEditor=ze,h.PlainTextRenderer=Qe,h.Point=y,h.RenderingDelegate=Je,h.SchemaContext=lt,h.ThumbnailEditor=We,h.ThumbnailRenderer=et,h.XAxisNodeLayout=Te,h.XYAxisNodeLayout=Me,h.YAxisNodeLayout=$e,h.domUtil=Bs,h.eventList=b,h.init=Et,h.initMindWired=Hs,h.installDefaultLayoutManagers=Oe,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=mind-wired.umd.cjs.map
